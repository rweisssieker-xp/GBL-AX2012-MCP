---
stepsCompleted: [1, 2, 3, 4, 5, 6]
inputDocuments:
  - "docs/analysis/product-brief-GBL-AX2012-MCP-2025-12-06.md"
workflowType: "prd"
status: "COMPLETED"
project_name: "GBL-AX2012-MCP"
user_name: "Reinerw"
date: "2025-12-06"
---

# Product Requirements Document: GBL-AX2012-MCP

**Version:** 1.0  
**Date:** 2025-12-06  
**Author:** Reinerw  
**Status:** Draft for Review

---

## Executive Summary

### Product Overview

**GBL-AX2012-MCP** ist ein Model Context Protocol (MCP) Server, der Microsoft Dynamics AX 2012 R3 CU13 für moderne AI-Agenten und Workflow-Orchestrierung zugänglich macht. Der Server ermöglicht sichere Read/Write-Operationen auf AX-Daten über ein standardisiertes Tool-Interface.

### Business Case

| Metric | Current State | Target State | Impact |
|--------|---------------|--------------|--------|
| Order Entry Time | 5 min/order | 30 sec/order | 90% reduction |
| Manual Data Entry | 60% of sales time | 20% of sales time | 2h/day saved |
| Integration Requests to IT | 10/month | 3/month | 70% reduction |
| Order Error Rate | 5% | <1% | 80% reduction |

### Success Criteria

- **MVP Launch (Month 3):** 6 P0 tools functional, 5 pilot users active
- **Rollout (Month 6):** >50% sales team adoption, >30% orders via MCP
- **Full O2C (Month 12):** All 4 phases live, >60% automation rate

---

## Functional Requirements

### FR-001: Health Check Tool

**Priority:** P0 (MVP)  
**Tool Name:** `ax_health_check`

#### Description
Prüft die Verfügbarkeit und Konnektivität des AX 2012 Systems.

#### Input Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `include_details` | boolean | No | Include detailed component status |

#### Output Schema
```json
{
  "status": "healthy|degraded|unhealthy",
  "aos_connected": true,
  "response_time_ms": 45,
  "timestamp": "2025-12-06T14:00:00Z",
  "details": {
    "database": "connected",
    "business_connector": "connected",
    "aif_services": "connected"
  }
}
```

#### Acceptance Criteria
- [ ] Returns status within 5 seconds
- [ ] Correctly identifies AOS connectivity issues
- [ ] No authentication required for basic health check
- [ ] Detailed check requires MCP_Admin role

---

### FR-002: Get Customer Tool

**Priority:** P0 (MVP)  
**Tool Name:** `ax_get_customer`

#### Description
Ruft Kundenstammdaten aus AX ab.

#### Input Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `customer_account` | string | Yes* | AX Customer Account ID |
| `customer_name` | string | Yes* | Customer name (fuzzy search) |
| `include_addresses` | boolean | No | Include address records |
| `include_contacts` | boolean | No | Include contact persons |

*Either `customer_account` OR `customer_name` required

#### Output Schema
```json
{
  "customer_account": "CUST-001",
  "name": "Müller GmbH",
  "currency": "EUR",
  "credit_limit": 100000.00,
  "credit_used": 45000.00,
  "payment_terms": "Net30",
  "price_group": "STANDARD",
  "addresses": [...],
  "contacts": [...]
}
```

#### Acceptance Criteria
- [ ] Returns customer data within 500ms (p95)
- [ ] Fuzzy search returns top 5 matches with confidence score
- [ ] Handles non-existent customer gracefully
- [ ] Requires MCP_Sales_Read role

---

### FR-003: Get Sales Order Tool

**Priority:** P0 (MVP)  
**Tool Name:** `ax_get_salesorder`

#### Description
Ruft Auftragsdaten inkl. Positionen und Status ab.

#### Input Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `sales_id` | string | Yes* | AX Sales Order ID |
| `customer_account` | string | Yes* | Get all orders for customer |
| `status_filter` | string[] | No | Filter by status |
| `date_from` | date | No | Order date from |
| `date_to` | date | No | Order date to |
| `include_lines` | boolean | No | Include order lines |

*Either `sales_id` OR `customer_account` required

#### Output Schema
```json
{
  "sales_id": "SO-2025-001234",
  "customer_account": "CUST-001",
  "customer_name": "Müller GmbH",
  "order_date": "2025-12-06",
  "requested_delivery": "2025-12-13",
  "status": "Open",
  "total_amount": 5000.00,
  "currency": "EUR",
  "lines": [
    {
      "line_num": 1,
      "item_id": "WIDGET-PRO",
      "item_name": "Widget Professional",
      "quantity": 50,
      "unit_price": 100.00,
      "line_amount": 5000.00,
      "reserved_qty": 30,
      "delivered_qty": 0,
      "status": "Partially Reserved"
    }
  ]
}
```

#### Acceptance Criteria
- [ ] Returns order data within 500ms (p95)
- [ ] Supports pagination for customer order lists
- [ ] Status filter works correctly
- [ ] Requires MCP_Sales_Read role

---

### FR-004: Check Inventory Tool

**Priority:** P0 (MVP)  
**Tool Name:** `ax_check_inventory`

#### Description
Prüft Bestandsverfügbarkeit für Artikel.

#### Input Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `item_id` | string | Yes | AX Item ID |
| `warehouse` | string | No | Specific warehouse |
| `include_reservations` | boolean | No | Show reserved quantities |

#### Output Schema
```json
{
  "item_id": "WIDGET-PRO",
  "item_name": "Widget Professional",
  "total_on_hand": 500,
  "available": 320,
  "reserved": 180,
  "on_order": 200,
  "warehouses": [
    {
      "warehouse_id": "WH-MAIN",
      "on_hand": 400,
      "available": 250,
      "reserved": 150
    },
    {
      "warehouse_id": "WH-EAST",
      "on_hand": 100,
      "available": 70,
      "reserved": 30
    }
  ]
}
```

#### Acceptance Criteria
- [ ] Returns inventory within 500ms (p95)
- [ ] Correctly calculates available = on_hand - reserved
- [ ] Warehouse breakdown is accurate
- [ ] Requires MCP_Inventory_Read role

---

### FR-005: Simulate Price Tool

**Priority:** P0 (MVP)  
**Tool Name:** `ax_simulate_price`

#### Description
Simuliert Preisfindung für Kunde/Artikel-Kombination ohne Auftrag anzulegen.

#### Input Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `customer_account` | string | Yes | Customer for pricing |
| `item_id` | string | Yes | Item to price |
| `quantity` | number | Yes | Quantity for price breaks |
| `unit` | string | No | Unit of measure |
| `date` | date | No | Price date (default: today) |

#### Output Schema
```json
{
  "customer_account": "CUST-001",
  "item_id": "WIDGET-PRO",
  "quantity": 50,
  "unit": "PCS",
  "base_price": 120.00,
  "customer_discount_pct": 10.0,
  "quantity_discount_pct": 5.0,
  "final_unit_price": 102.60,
  "line_amount": 5130.00,
  "currency": "EUR",
  "price_source": "Trade Agreement",
  "valid_until": "2025-12-31"
}
```

#### Acceptance Criteria
- [ ] Returns price within 1 second (p95)
- [ ] Applies all relevant trade agreements
- [ ] Applies customer-specific discounts
- [ ] Applies quantity breaks correctly
- [ ] Requires MCP_Sales_Read role

---

### FR-006: Create Sales Order Tool

**Priority:** P0 (MVP)  
**Tool Name:** `ax_create_salesorder`

#### Description
Erstellt einen neuen Verkaufsauftrag in AX.

#### Input Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `customer_account` | string | Yes | Customer account |
| `requested_delivery` | date | No | Requested delivery date |
| `customer_ref` | string | No | Customer reference/PO |
| `lines` | array | Yes | Order lines |
| `lines[].item_id` | string | Yes | Item ID |
| `lines[].quantity` | number | Yes | Quantity |
| `lines[].unit_price` | number | No | Override price |
| `lines[].warehouse` | string | No | Ship from warehouse |
| `idempotency_key` | string | Yes | Unique key for retry safety |

#### Output Schema
```json
{
  "success": true,
  "sales_id": "SO-2025-001234",
  "customer_account": "CUST-001",
  "order_date": "2025-12-06",
  "total_amount": 5130.00,
  "currency": "EUR",
  "lines_created": 1,
  "warnings": [],
  "audit_id": "AUD-2025-12-06-001234"
}
```

#### Validation Rules
| Rule | Description | Error Code |
|------|-------------|------------|
| Customer exists | Customer account must exist in AX | CUST_NOT_FOUND |
| Customer active | Customer must not be blocked | CUST_BLOCKED |
| Credit check | Order must not exceed credit limit | CREDIT_EXCEEDED |
| Item exists | All items must exist in AX | ITEM_NOT_FOUND |
| Item active | Items must not be blocked for sales | ITEM_BLOCKED |
| Quantity positive | All quantities must be > 0 | INVALID_QTY |
| Idempotency | Duplicate key returns existing order | DUPLICATE_KEY |

#### Acceptance Criteria
- [ ] Creates order within 2 seconds (p95)
- [ ] All validation rules enforced
- [ ] Idempotency key prevents duplicates
- [ ] Full audit trail created
- [ ] Requires MCP_Sales_Write role
- [ ] Requires human approval for orders > €50,000

---

## Non-Functional Requirements

### NFR-001: Performance

| Metric | Target | Measurement |
|--------|--------|-------------|
| Read Operations (p95) | <500ms | APM |
| Write Operations (p95) | <2s | APM |
| Concurrent Users | 20 | Load Test |
| Throughput | 100 ops/min | Monitoring |

### NFR-002: Availability

| Metric | Target | Measurement |
|--------|--------|-------------|
| Uptime | 99.5% | Monitoring |
| Planned Downtime | <4h/month | Change Log |
| Recovery Time | <15 min | Incident Log |

### NFR-003: Security

| Requirement | Implementation |
|-------------|----------------|
| Authentication | Windows Authentication / Service Account |
| Authorization | Role-based (MCP_Read, MCP_Write, MCP_Admin) |
| Audit Logging | All operations logged with user, timestamp, payload |
| Data Encryption | TLS 1.2+ in transit |
| Input Validation | Schema validation + AX reference validation |

### NFR-004: Resilience

| Pattern | Configuration |
|---------|---------------|
| Circuit Breaker | 30s timeout, 3 failures to open, 60s half-open |
| Rate Limiting | 100 requests/min/user |
| Retry | Exponential backoff, max 2 retries |
| Idempotency | Required for all write operations |

---

## User Stories

### Epic: Order Capture Automation

#### US-001: Quick Order Entry
**As a** Sales Representative  
**I want to** create orders via chat command  
**So that** I can serve customers faster without navigating the AX client

**Acceptance Criteria:**
- Given I have MCP_Sales_Write role
- When I say "Create order for Müller, 50 Widget Pro"
- Then the system creates the order and returns the Sales ID
- And the order appears in AX within 5 seconds

**Story Points:** 8

---

#### US-002: Customer Lookup
**As a** Customer Service Rep  
**I want to** find customer info by name  
**So that** I can answer questions during phone calls

**Acceptance Criteria:**
- Given I have MCP_Sales_Read role
- When I search for "Müller"
- Then I see matching customers with confidence scores
- And I can select the correct one

**Story Points:** 3

---

#### US-003: Order Status Check
**As a** Customer Service Rep  
**I want to** check order status instantly  
**So that** I can answer "where is my order" questions

**Acceptance Criteria:**
- Given I have MCP_Sales_Read role
- When I query order SO-2025-001234
- Then I see status, delivery date, and line details
- And I can see which items are reserved/shipped

**Story Points:** 3

---

#### US-004: Price Quote
**As a** Sales Representative  
**I want to** get a price quote without creating an order  
**So that** I can answer pricing questions immediately

**Acceptance Criteria:**
- Given I have MCP_Sales_Read role
- When I request price for customer + item + quantity
- Then I see the final price with all discounts applied
- And I see the price source and validity

**Story Points:** 5

---

#### US-005: Inventory Check
**As a** Sales Representative  
**I want to** check if items are in stock  
**So that** I can promise realistic delivery dates

**Acceptance Criteria:**
- Given I have MCP_Inventory_Read role
- When I check inventory for an item
- Then I see available quantity per warehouse
- And I see what's reserved vs. on hand

**Story Points:** 3

---

### Epic: System Administration

#### US-006: Health Monitoring
**As an** IT Administrator  
**I want to** check MCP server health  
**So that** I can proactively identify issues

**Acceptance Criteria:**
- Given I have MCP_Admin role
- When I call health check
- Then I see status of all components
- And I see response times

**Story Points:** 2

---

#### US-007: Audit Trail
**As an** IT Administrator  
**I want to** review all MCP operations  
**So that** I can troubleshoot issues and ensure compliance

**Acceptance Criteria:**
- Given I have MCP_Admin role
- When I query the audit log
- Then I see all operations with user, timestamp, and payload
- And I can filter by date, user, or operation type

**Story Points:** 5

---

## Technical Specifications

### Integration Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         MCP CLIENTS                                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                │
│  │ Claude  │  │ Cursor  │  │ n8n     │  │ Custom  │                │
│  │ Desktop │  │ IDE     │  │ Flows   │  │ Apps    │                │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                │
│       └────────────┴────────────┴────────────┘                      │
│                         │ MCP Protocol (stdio/SSE)                  │
├─────────────────────────┼───────────────────────────────────────────┤
│                         ▼                                           │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    MCP SERVER (.NET 8)                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │   │
│  │  │ Rate Limiter│→ │ Validator   │→ │ Circuit     │          │   │
│  │  │ 100/min/user│  │ Schema+Ref  │  │ Breaker     │          │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │   │
│  │         │                │                │                  │   │
│  │         ▼                ▼                ▼                  │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │              TOOL HANDLERS                           │    │   │
│  │  │  ax_health_check | ax_get_customer | ax_get_sales.. │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  │         │                                                    │   │
│  │         ▼                                                    │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │              AX CONNECTOR LAYER                      │    │   │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐        │    │   │
│  │  │  │ AIF Client│  │ WCF Client│  │ BC.NET    │        │    │   │
│  │  │  │ (Reads)   │  │ (Writes)  │  │ (Admin)   │        │    │   │
│  │  │  └───────────┘  └───────────┘  └───────────┘        │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  │         │                                                    │   │
│  │         ▼                                                    │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │              AUDIT + LOGGING                         │    │   │
│  │  │  Database (Writes) | File (Reads) | Event Stream    │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                         │                                           │
├─────────────────────────┼───────────────────────────────────────────┤
│                         ▼                                           │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                 AX 2012 R3 CU13                              │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                │   │
│  │  │ AIF       │  │ Custom    │  │ Business  │                │   │
│  │  │ Services  │  │ WCF Svc   │  │ Connector │                │   │
│  │  └───────────┘  └───────────┘  └───────────┘                │   │
│  │         │              │              │                      │   │
│  │         └──────────────┴──────────────┘                      │   │
│  │                        │                                     │   │
│  │                        ▼                                     │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │                 AX DATABASE                          │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### Data Flow: Create Sales Order

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │     │   MCP    │     │  Custom  │     │    AX    │
│ (Claude) │     │  Server  │     │   WCF    │     │  2012    │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ ax_create_     │                │                │
     │ salesorder     │                │                │
     │ ───────────────>                │                │
     │                │                │                │
     │                │ 1. Rate Limit  │                │
     │                │    Check       │                │
     │                │ ──────────────>│                │
     │                │                │                │
     │                │ 2. Validate    │                │
     │                │    Schema      │                │
     │                │ ──────────────>│                │
     │                │                │                │
     │                │ 3. Check       │                │
     │                │    Idempotency │                │
     │                │ ──────────────>│                │
     │                │                │                │
     │                │ 4. Validate    │                │
     │                │    Customer    │                │
     │                │ ───────────────────────────────>│
     │                │                │                │
     │                │ 5. Validate    │                │
     │                │    Items       │                │
     │                │ ───────────────────────────────>│
     │                │                │                │
     │                │ 6. Check       │                │
     │                │    Credit      │                │
     │                │ ───────────────────────────────>│
     │                │                │                │
     │                │ 7. Create      │                │
     │                │    Order       │                │
     │                │ ───────────────>                │
     │                │                │ CreateSalesOrder│
     │                │                │ ───────────────>│
     │                │                │                │
     │                │                │    SalesId     │
     │                │                │ <───────────────│
     │                │                │                │
     │                │ 8. Audit Log   │                │
     │                │ ──────────────>│                │
     │                │                │                │
     │   Response     │                │                │
     │ <───────────────                │                │
     │                │                │                │
```

---

## Appendix

### A. Error Codes

| Code | Description | HTTP Status | User Message |
|------|-------------|-------------|--------------|
| CUST_NOT_FOUND | Customer account does not exist | 404 | "Customer not found" |
| CUST_BLOCKED | Customer is blocked for orders | 400 | "Customer is blocked" |
| CREDIT_EXCEEDED | Order exceeds credit limit | 400 | "Credit limit exceeded" |
| ITEM_NOT_FOUND | Item does not exist | 404 | "Item not found" |
| ITEM_BLOCKED | Item is blocked for sales | 400 | "Item not available" |
| INVALID_QTY | Quantity must be positive | 400 | "Invalid quantity" |
| DUPLICATE_KEY | Idempotency key already used | 409 | "Duplicate request" |
| AX_TIMEOUT | AX did not respond in time | 504 | "System temporarily unavailable" |
| AX_ERROR | AX returned an error | 500 | "System error" |
| RATE_LIMITED | Too many requests | 429 | "Please slow down" |
| UNAUTHORIZED | Missing or invalid credentials | 401 | "Not authorized" |
| FORBIDDEN | Insufficient permissions | 403 | "Access denied" |

### B. Role Permissions

| Role | Health | Read Customer | Read Order | Read Inventory | Price | Create Order |
|------|--------|---------------|------------|----------------|-------|--------------|
| MCP_Read | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| MCP_Write | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| MCP_Admin | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |

### C. Glossary

| Term | Definition |
|------|------------|
| AIF | Application Integration Framework - AX's built-in web services |
| AOS | Application Object Server - AX's application tier |
| BC.NET | Business Connector .NET - Direct .NET integration with AX |
| MCP | Model Context Protocol - Anthropic's standard for AI tool integration |
| O2C | Order-to-Cash - Business process from order to payment |
| WCF | Windows Communication Foundation - Microsoft's service framework |

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-06 | Reinerw | Initial PRD created from Product Brief |

---

## Approval

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Product Owner | | | |
| Tech Lead | | | |
| Business Stakeholder | | | |
